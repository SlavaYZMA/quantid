<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Квантовая идентичность · Влада Садик</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap">
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
<script src="https://cdn.jsdelivr.net/npm/ml-kmeans@6.0.0/dist/index.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;overflow:hidden;background:#000;font-family:'IBM Plex Mono',monospace}
  canvas{position:fixed;inset:0;z-index:1;transition:filter 1.8s ease;filter:brightness(0.38) blur(4px)}
  canvas.clear{filter:none}
  .intro{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;color:#fff;text-align:center;padding:40px;opacity:0;visibility:hidden;transition:opacity 1.6s ease}
  .intro.active{opacity:1;visibility:visible}
  .intro h1{font-size:38px;font-weight:600;letter-spacing:6px;margin-bottom:16px}
  .intro .year{font-size:18px;margin-bottom:40px;opacity:0.9}
  .intro p{font-size:17px;line-height:1.8;max-width:720px;margin:28px auto}
  .intro input{background:transparent;border:none;border-bottom:1px solid #fff;color:#fff;font-size:19px;padding:12px 0;width:320px;max-width:90%;text-align:center;outline:none;margin:30px 0 40px}
  .intro button{background:none;border:none;color:#fff;font-size:18px;letter-spacing:3px;cursor:pointer;padding:10px 0;position:relative}
  .intro button::after{content:'';position:absolute;left:0;right:0;bottom:0;height:1px;background:#fff;transform:scaleX(0);transition:transform 0.4s ease}
  .intro button:hover::after{transform:scaleX(1)}
  .back{position:fixed;top:24px;left:24px;z-index:20;color:#fff;font-size:15px;background:rgba(0,0,0,0.6);padding:8px 16px;cursor:pointer;display:none;border-bottom:1px solid #fff}
  .back.active{display:block}
  .speed{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:20;color:#fff;font-size:17px;background:rgba(0,0,0,0.7);padding:8px 24px;display:none}
  .speed.active{display:block}
  .desc{position:fixed;bottom:24px;left:24px;right:24px;z-index:20;color:#fff;font-size:16px;line-height:1.7;background:rgba(0,0,0,0.5);padding:20px;display:none}
  .desc.active{display:block}
  .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30;color:#fff;font-size:22px;background:rgba(0,0,0,0.9);padding:35px 70px;border:1px solid #fff;display:none;line-height:1.6}
  .download-btn{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:18px 40px;font-size:18px;letter-spacing:3px;cursor:pointer;z-index:30;border:2px solid #fff;border-radius:8px;box-shadow:0 15px 40px rgba(0,0,0,0.7);font-weight:600;display:none}
  .download-btn.active{display:block}
</style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loading" id="loading">Читаю Instagram…</div>

<div class="intro active" id="welcome">
  <div>
    <h1>КВАНТОВАЯ ИДЕНТИЧНОСТЬ</h1>
    <div class="year">2025—2026 · Влада Садик</div>
    <p>Идентичность — не монолит. Это суперпозиция множества версий себя.<br>Проект извлекает их из твоего Instagram и строит живую QCD-пену.</p>
    <button onclick="showUsername()">НАЧАТЬ</button>
  </div>
</div>

<div class="intro" id="username">
  <div>
    <h1>ВВЕДИ СВОЙ INSTAGRAM</h1>
    <p>Только публичный профиль</p>
    <input type="text" id="user" placeholder="@username" autocomplete="off">
    <button onclick="enter()">АНАЛИЗ</button>
  </div>
</div>

<div class="back" id="back">← назад</div>
<div class="speed" id="speed">скор ×1.00</div>
<div class="desc" id="desc">загрузка...</div>
<div class="download-btn" id="downloadBtn">СКАЧАТЬ ОНТОЛОГИЮ (TXT)</div>

<script>
const APIFY_TOKEN = "apify_api_XFk4W4rmvDDfnSxhsYzkUbHnHPdJ0R1I2wyz";

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.onresize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };

const size = 96;
const field = new Float32Array(size * size * size);
let t = 0;
let speed = 1.0;
let roleWeights = Array(8).fill(1);
let clusterLabels = ["творец","мама","дочь","тревожная","куратор","тело","киборг","наблюдатель"];

document.addEventListener('wheel', e => {
  speed = e.deltaY < 0 ? Math.min(speed * 1.4, 100) : Math.max(speed / 1.4, 0.01);
  document.getElementById('speed').textContent = `скор ×${speed.toFixed(2)}`;
});

for (let i = 0; i < 40; i++) createCluster();

function createCluster() {
  const x0 = Math.random() * size, y0 = Math.random() * size, z0 = Math.random() * size;
  const rho = 5 + Math.random() * 9;
  const total = roleWeights.reduce((a, b) => a + b, 0);
  let r = 0, rand = Math.random() * total;
  for (; r < roleWeights.length; r++) { rand -= roleWeights[r]; if (rand <= 0) break; }
  if (r >= roleWeights.length) r = roleWeights.length - 1;

  const s = roleWeights[r] * (1.6 + Math.random() * 0.8);
  const phase = Math.random() * Math.PI * 2;

  for (let dx = -rho * 2 | 0; dx < rho * 2; dx++)
  for (let dy = -rho * 2 | 0; dy < rho * 2; dy++)
  for (let dz = -rho * 2 | 0; dz < rho * 2; dz++) {
    const x = Math.floor(x0 + dx), y = Math.floor(y0 + dy), z = Math.floor(z0 + dz);
    if (x < 0 || x >= size || y < 0 || y >= size || z < 0 || z >= size) continue;
    const d = Math.hypot(dx, dy, dz);
    if (d < rho * 1.8) field[z * size * size + y * size + x] += s * Math.exp(-d * d / (rho * rho)) * Math.cos(t * 0.03 + phase);
  }
}

setInterval(() => {
  t += 0.018 * speed;
  const decay = Math.pow(0.996, speed);
  for (let i = 0; i < field.length; i++) field[i] *= decay;
  if (Math.random() < 0.16 * speed) createCluster();

  ctx.fillStyle = '#000008';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  const sx = canvas.width / size, sy = canvas.height / size;
  for (let y = 0; y < size; y++)
  for (let x = 0; x < size; x++) {
    let sum = 0;
    for (let z = 0; z < size; z++) sum += field[z * size * size + y * size + x];
    const q = sum / size;
    if (Math.abs(q) > 0.011) {
      const hue = q > 0 ? 188 : 298;
      const i = Math.min(Math.abs(q) * 11, 1);
      ctx.fillStyle = `hsla(${hue},100%,${58 + i * 37}%,${i})`;
      ctx.fillRect(x * sx, y * sy, sx + 1, sy + 1);
    }
  }
}, 16);

function showUsername() {
  document.getElementById('welcome').classList.remove('active');
  document.getElementById('username').classList.add('active');
  setTimeout(() => document.getElementById('user').focus(), 300);
}

let transformer = null;
async function loadModel() {
  if (transformer) return transformer;
  document.getElementById('loading').innerHTML = "Загрузка нейросети…<br>(~80 Мб, один раз)";
  transformer = await Xenova.pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
  return transformer;
}

async function enter() {
  const raw = document.getElementById('user').value.trim().replace(/^@/, '');
  if (!raw) return alert("Введи username");

  document.getElementById('loaduser').textContent = raw;
  document.getElementById('loading').style.display = 'block';

  let sentences = [];
  try {
    const res = await fetch("https://api.apify.com/v2/acts/apify~instagram-profile-scraper/run-sync-get-dataset-items?token=" + APIFY_TOKEN, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ usernames: [raw], resultsLimit: 30 })
    });
    const data = await res.json();
    if (data?.[0]) {
      const p = data[0];
      if (p.biography) sentences.push(p.biography.trim());
      (p.latestPosts || []).forEach(post => {
        if (post.caption) sentences.push(post.caption.trim());
      });
    }
  } catch (e) { console.log("Instagram error", e); }

  if (sentences.length === 0) {
    fallback(raw);
    return;
  }

  document.getElementById('loading').innerHTML = "Анализ идентичностей…";

  try {
    const model = await loadModel();
    const embeddings = [];
    for (const s of sentences) {
      const result = await model(s, { pooling: 'mean', normalize: true });
      embeddings.push(Array.from(result.data));
    }

    const k = Math.max(5, Math.min(12, Math.ceil(sentences.length / 3)));
    const { clusters } = kmeans(embeddings, k);

    const groups = Array.from({length: k}, () => []);
    sentences.forEach((s, i) => groups[clusters[i]].push(s));

    clusterLabels = [];
    roleWeights = [];
    for (const group of groups) {
      if (group.length === 0) continue;
      const text = group.join(" ").toLowerCase();
      const words = text.match(/[а-яa-z]+/g) || [];
      const freq = {};
      words.forEach(w => freq[w] = (freq[w] || 0) + 1);
      const top = Object.entries(freq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 4)
        .map(e => e[0]);
      clusterLabels.push(top.join(" "));
      roleWeights.push(group.length);
    }

    const sum = roleWeights.reduce((a, b) => a + b, 0);
    roleWeights = roleWeights.map(w => w / sum * 20);

  } catch (e) {
    console.log("ML error", e);
    fallback(raw);
    return;
  }

  finish(raw, sentences);
}

function fallback(username) {
  clusterLabels = ["творец","мама","тревожная","куратор","киборг"];
  roleWeights = [3,2,2,2,1];
  finish(username, []);
}

function finish(username, sentences) {
  let txt = `КВАНТОВАЯ ИДЕНТИЧНОСТЬ · @${username}\n${new Date().toLocaleString('ru-RU')}\n\n`;
  txt += `Обнаружено идентичностей: ${clusterLabels.length}\n\n`;
  clusterLabels.forEach((label, i) => {
    txt += `${i+1}. ${label.toUpperCase()}\n`;
  });
  if (sentences.length > 0) txt += `\n\nПосты (${sentences.length}):\n` + sentences.map((s, i) => `${i+1}. ${s}`).join('\n');

  const blob = new Blob([txt], {type: "text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  document.getElementById('downloadBtn').onclick = () => {
    const a = document.createElement('a');
    a.href = url;
    a.download = `identity_${username}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
  };
  document.getElementById('downloadBtn').classList.add('active');

  document.title = `Идентичность · @${username}`;
  document.getElementById('loading').style.display = 'none';
  document.getElementById('username').classList.remove('active');
  canvas.classList.add('clear');
  document.getElementById('back').classList.add('active');
  document.getElementById('speed').classList.add('active');
  document.getElementById('desc').classList.add('active');
  document.getElementById('desc').textContent = clusterLabels.slice(0, 5).map(l => l.toUpperCase()).join(" · ");
}

document.getElementById('back').onclick = () => location.reload();
document.getElementById('user')?.addEventListener('keypress', e => { if (e.key === 'Enter') enter(); });
</script>
</body>
</html>
