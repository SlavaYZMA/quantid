<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Квантовая идентичность · Влада Садик</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap">
<script type="module" src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
<script src="https://cdn.jsdelivr.net/npm/ml-kmeans@6.0.0/dist/index.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body,html{height:100%;overflow:hidden;background:#000;font-family:'IBM Plex Mono',monospace}
  canvas{position:fixed;inset:0;z-index:1;transition:filter 1.8s ease;filter:brightness(0.38) blur(4px)}
  canvas.clear{filter:none}
  .intro{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;color:#fff;text-align:center;padding:40px;opacity:0;visibility:hidden;transition:opacity 1.6s ease}
  .intro.active{opacity:1;visibility:visible}
  .intro h1{font-size:38px;font-weight:600;letter-spacing:6px;margin-bottom:16px}
  .intro p{font-size:17px;line-height:1.8;max-width:720px;margin:28px auto}
  .intro input{background:transparent;border:none;border-bottom:1px solid #fff;color:#fff;font-size:19px;padding:12px 0;width:320px;max-width:90%;text-align:center;outline:none;margin:30px 0 40px}
  .intro button{background:none;border:none;color:#fff;font-size:18px;letter-spacing:3px;cursor:pointer;padding:10px 0;position:relative}
  .intro button::after{content:'';position:absolute;left:0;right:0;bottom:0;height:1px;background:#fff;transform:scaleX(0);transition:transform 0.4s ease}
  .intro button:hover::after{transform:scaleX(1)}
  .back{position:fixed;top:24px;left:24px;z-index:20;color:#fff;font-size:15px;background:rgba(0,0,0,0.6);padding:8px 16px;cursor:pointer;display:none;border-bottom:1px solid #fff}
  .back.active{display:block}
  .speed{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:20;color:#fff;font-size:17px;background:rgba(0,0,0,0.7);padding:8px 24px;display:none}
  .speed.active{display:block}
  .desc{position:fixed;bottom:24px;left:24px;right:24px;z-index:20;color:#fff;font-size:16px;line-height:1.7;background:rgba(0,0,0,0.5);padding:20px;display:none}
  .desc.active{display:block}
  .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30;color:#fff;font-size:22px;background:rgba(0,0,0,0.9);padding:35px 70px;border:1px solid #fff;display:none}
  .download-btn{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:18px 40px;font-size:18px;letter-spacing:3px;cursor:pointer;z-index:30;border:2px solid #fff;border-radius:8px;box-shadow:0 15px 40px rgba(0,0,0,0.7);font-weight:600;display:none}
  .download-btn.active{display:block}

  .terminal{
    position:fixed;bottom:24px;right:24px;z-index:25;width:480px;max-height:70vh;
    background:#000;border:1px solid #0f8;padding:16px;font-size:13px;line-height:1.8;
    color:#0f8;overflow-y:auto;display:none;opacity:0;transition:all 0.6s ease;
    box-shadow:0 0 40px rgba(0,255,136,0.25);backdrop-filter:blur(4px);
  }
  .terminal.active{display:block;opacity:1;}
  .terminal-toggle{
    position:fixed;bottom:24px;right:24px;z-index:26;background:rgba(0,255,136,0.15);
    color:#0f8;padding:10px 18px;font-size:13px;cursor:pointer;border:1px solid #0f8;
    display:none;transition:all 0.4s;
  }
  .terminal-toggle.active{display:block;}
  .terminal-toggle:hover{background:rgba(0,255,136,0.3);}
</style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loading" id="loading">Читаю Instagram @<span id="loaduser"></span>…</div>

<div class="intro active" id="welcome">
  <div>
    <h1>КВАНТОВАЯ ИДЕНТИЧНОСТЬ</h1>
    <div class="year">2025—2026 · Влада Садик</div>
    <p>Ты — суперпозиция. Этот проект коллапсирует тебя в живую QCD-пену из твоих слов.</p>
    <button onclick="showUsername()">НАЧАТЬ</button>
  </div>
</div>

<div class="intro" id="username">
  <div>
    <h1>ВВЕДИ СВОЙ INSTAGRAM</h1>
    <p>Только публичный профиль · ничего не сохраняется</p>
    <input type="text" id="user" placeholder="@username" autocomplete="off">
    <button onclick="enter()">ЗАПУСТИТЬ</button>
  </div>
</div>

<div class="back" id="back">← назад</div>
<div class="speed" id="speed">скор ×1.00</div>
<div class="desc" id="desc">загрузка...</div>
<div class="download-btn" id="downloadBtn">СКАЧАТЬ ОНТОЛОГИЮ (TXT)</div>

<div class="terminal-toggle" id="terminalToggle">ТЕРМИНАЛ ▶</div>
<div class="terminal" id="terminal"></div>

<script type="module">
import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

// === ВСЁ ОСТАЛЬНОЕ ОСТАЁТСЯ КАК БЫЛО, НО УЖЕ ВНУТРИ MODULE ===

const APIFY_TOKEN = "apify_api_XFk4W4rmvDDfnSxhsYzkUbHnHPdJ0R1I2wyz";

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.onresize = ()=>{canvas.width=innerWidth; canvas.height=innerHeight};

const size = 96;
const field = new Float32Array(size*size*size);
let t = 0;
let speed = 1.0;

let clusters = [
  {name:"творец", weight:1, coherence:0.7, freq:0.03, phase:0, charge:1},
  {name:"мама", weight:1, coherence:0.7, freq:0.04, phase:0.5, charge:-0.5},
  {name:"дочь", weight:1, coherence:0.9, freq:0.02, phase:0, charge:0.8},
  {name:"тревожная", weight:1, coherence:0.5, freq:0.06, phase:Math.PI, charge:-1},
  {name:"куратор", weight:1, coherence:0.8, freq:0.035, phase:0.2, charge:1},
  {name:"тело", weight:1, coherence:0.6, freq:0.05, phase:1.2, charge:-0.3},
  {name:"постчеловек", weight:1, coherence:0.75, freq:0.045, phase:0.8, charge:1},
  {name:"наблюдатель", weight:1, coherence:0.95, freq:0.015, phase:0, charge:0.5}
];

let prevEnergy = clusters.map(() => 12.5);
let lastLogTime = 0;
const log = [];

function logEvent(msg){
  if(t - lastLog Seymour < 10) return;
  lastLogTime = t;
  const line = `[t=${t.toFixed(1)}] ${msg}`;
  log.push(line);
  if(log.length > 120) log.shift();
  const term = document.getElementById('terminal');
  if(term){
    term.innerHTML = log.join('<br>') + '<br>';
    term.scrollTop = term.scrollHeight;
  }
}

document.addEventListener('wheel', e=>{
  speed = e.deltaY<0 ? Math.min(speed*1.4,100) : Math.max(speed/1.4,0.01);
  document.getElementById('speed').textContent = `скор ×${speed.toFixed(2)}`;
});

function createCluster(){
  const total = clusters.reduce((s,c)=>s + c.weight * c.coherence, 0);
  let r = Math.random() * total;
  let chosen;
  for(const c of clusters){
    r -= c.weight * c.coherence;
    if(r <= 0){ chosen = c; break; }
  }
  if(!chosen) chosen = clusters[0];

  const x0 = Math.random()*size, y0 = Math.random()*size, z0 = Math.random()*size;
  const rho = 4 + chosen.coherence * 10;
  const amplitude = chosen.weight * (1.4 + Math.random()*1.2);

  let added = false;
  for(let dx=-18;dx<18;dx++)for(let dy=-18;dy<18;dy++)for(let dz=-18;dz<18;dz++){
    const x=Math.floor(x0+dx), y=Math.floor(y0+dy), z=Math.floor(z0+dz);
    if(x<0||x>=size||y<0||y>=size||z<0||z>=size) continue;
    const d=Math.hypot(dx,dy,dz);
    if(d < rho*1.8){
      const wave = Math.cos(t * chosen.freq * speed + chosen.phase + d*0.1);
      field[z*size*size + y*size + x] += amplitude * Math.exp(-d*d/(rho*rho)) * wave * chosen.charge;
      added = true;
    }
  }
  if(added && Math.random()<0.07){
    logEvent(`"${chosen.name}" рождает инстантон → ${chosen.weight} постов, когерентность ${chosen.coherence.toFixed(2)}`);
  }
}

for(let i=0;i<50;i++) createCluster();

setInterval(()=>{
  t += 0.018 * speed;
  const decay = Math.pow(0.996, speed);
  for(let i=0;i<field.length;i++) field[i] *= decay;
  if(Math.random() < 0.18 * speed) createCluster();

  const energy = clusters.map(()=>0);
  for(let i=0;i<field.length;i++){
    const v = field[i];
    const a = Math.abs(v);
    if(a > 0.35){
      let best = 0, bestScore = 0;
      for(let c=0; c<clusters.length; c++){
        const expected = Math.cos(t * clusters[c].freq * speed + clusters[c].phase);
        const score = a * ((v > 0) === (expected > 0) ? 1 : 0.1);
        if(score > bestScore){ bestScore = score; best = c; }
      }
      energy[best] += a;
    }
  }
  const sumE = energy.reduce((a,b)=>a+b, 0.0001);
  const perc = energy.map(e=>e/sumE*100);

  for(let i=0;i<clusters.length;i++){
    const delta = perc[i] - prevEnergy[i];
    if(Math.abs(delta) > 12){
      const dir = delta > 0 ? "доминирует ↑" : "подавляется ↓";
      const reason = delta > 0 
        ? `сильный вес и когерентность ${clusters[i].coherence.toFixed(2)} → устойчивые волны`
        : `деструктивная интерференция`;
      logEvent(`"${clusters[i].name}" ${dir} ${perc[i].toFixed(1)}% → ${reason}`);
    }
    if(perc[i] > 48){
      logEvent(`"${clusters[i].name}" захватывает вакуум → полное доминирование`);
    }
  }

  if(Math.random() < 0.004){
    const a = Math.floor(Math.random()*clusters.length);
    const b = Math.floor(Math.random()*clusters.length);
    if(a !== b && Math.abs(clusters[a].phase - clusters[b].phase) < 0.4){
      logEvent(`"${clusters[a].name}" и "${clusters[b].name}" синхронизировались → конструктивная интерференция`);
    }
  }

  prevEnergy = [...perc];

  document.getElementById('desc').textContent = 
    clusters.map((c,i)=>`${c.name} ${perc[i].toFixed(1)}%`).slice(0,6).join(" · ");

  ctx.fillStyle='#000008';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const sx=canvas.width/size, sy=canvas.height/size;
  for(let y=0;y<size;y++)for(let x=0;x<size;x++){
    let sum=0;
    for(let z=0;z<size;z++) sum+=field[z*size*size+y*size+x];
    const q=sum/size;
    if(Math.abs(q)>0.011){
      const hue=q>0?188:298;
      const i=Math.min(Math.abs(q)*11,1);
      ctx.fillStyle=`hsla(${hue},100%,${58+i*37}%,${i})`;
      ctx.fillRect(x*sx,y*sy,sx+1,sy+1);
    }
  }
},16);

function showUsername(){
  document.getElementById('welcome').classList.remove('active');
  document.getElementById('username').classList.add('active');
  setTimeout(()=>document.getElementById('user').focus(),300);
}

let model = null;
async function getModel(){
  if(model) return model;
  document.getElementById('loading').innerHTML = "Загружаю ИИ-мозг…<br>(80 Мб, один раз)";
  model = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
  return model;
}

async function enter(){
  const raw = document.getElementById('user').value.trim().replace(/^@/,'');
  if(!raw) return alert("Введи username");

  document.getElementById('loaduser').textContent = raw;
  document.getElementById('loading').style.display = 'block';

  let sentences = [];
  try {
    const res = await fetch("https://api.apify.com/v2/acts/apify~instagram-profile-scraper/run-sync-get-dataset-items?token="+APIFY_TOKEN, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({usernames:[raw], resultsLimit:40})
    });
    const data = await res.json();
    if(data[0]){
      const bio = (data[0].biography||"").trim();
      if(bio) sentences.push(bio);
      (data[0].latestPosts||[]).forEach(p=>p.caption&&p.caption.trim()&&sentences.push(p.caption.trim()));
    }
  }catch(e){}

  if(sentences.length===0){
    finishWithFallback(raw);
    return;
  }

  document.getElementById('loading').innerHTML = "Построение онтологии из твоих слов…";

  try{
    const m = await getModel();
    const embeds = [];
    for(const s of sentences){
      const o = await m(s, {pooling:'mean', normalize:true});
      embeds.push(Array.from(o.data));
    }

    const k = Math.max(5, Math.min(14, Math.ceil(sentences.length/3)));
    const {clusters:labels} = kmeans(embeds, k);

    const newClusters = [];
    for(let i=0;i<k;i++){
      const idxs = labels.map((l,j)=>l===i?j:-1).filter(x=>x>=0);
      const texts = idxs.map(j=>sentences[j]);
      const words = texts.join(" ").toLowerCase().replace(/[^а-яa-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>3);
      const freq = {};
      words.forEach(w=>freq[w]=(freq[w]||0)+1);
      const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]).join(" ") || "тайна";

      let coh = 0.9;
      if(idxs.length>1){
        let dists = 0;
        const vecs = idxs.map(j=>embeds[j]);
        for(let a=0;a<vecs.length;a++)for(let b=a+1;b<vecs.length;b++){
          dists += Math.sqrt(vecs[a].reduce((s,v,j)=>s+(v-vecs[b][j])**2,0));
        }
        coh = Math.max(0.3, 1 - dists/(vecs.length*(vecs.length-1)/2 * 0.5));
      }

      newClusters.push({
        name: top,
        weight: texts.length,
        coherence: coh,
        freq: 0.02 + Math.random()*0.04,
        phase: Math.random()*Math.PI*2,
        charge: Math.random()>0.5 ? 1 : -1
      });
    }

    clusters = newClusters;
    prevEnergy = new Array(clusters.length).fill(100 / clusters.length);
    lastLogTime = t;
    log.length = 0;

  }catch(e){ console.log("ИИ не сработал", e); }

  let txt = `КВАНТОВАЯ ОНТОЛОГИЯ · @${raw}\n${new Date().toLocaleString('ru-RU')}\n\n`;
  clusters.forEach((c,i)=>txt+=`${i+1}. ${c.name.toUpperCase()}\n`);
  txt += `\n\nПосты:\n` + sentences.map((s,i)=>`${i+1}. ${s}`).join('\n');

  const blob = new Blob([txt],{type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  document.getElementById('downloadBtn').onclick = ()=>{const a=document.createElement('a');a.href=url;a.download=`ontology_${raw}_${new Date().toISOString().slice(0,10)}.txt`;a.click();};
  document.getElementById('downloadBtn').classList.add('active');

  document.title = `Квантовая онтология · @${raw}`;
  document.getElementById('loading').style.display='none';
  document.getElementById('username').classList.remove('active');
  canvas.classList.add('clear');
  document.getElementById('back').classList.add('active');
  document.getElementById('speed').classList.add('active');
  document.getElementById('desc').classList.add('active');
  document.getElementById('terminalToggle').classList.add('active');
  document.getElementById('desc').textContent = `@${raw} · ${clusters.slice(0,5).map(c=>c.name).join(" · ")}`;
}

function finishWithFallback(u){
  document.getElementById('loading').style.display='none';
  document.getElementById('username').classList.remove('active');
  canvas.classList.add('clear');
  document.getElementById('back').classList.add('active');
  document.getElementById('speed').classList.add('active');
  document.getElementById('desc').classList.add('active');
  document.getElementById('desc').textContent = `@${u} · базовый портрет`;
}

document.getElementById('terminalToggle').onclick = () => {
  const term = document.getElementById('terminal');
  const tog = document.getElementById('terminalToggle');
  term.classList.toggle('active');
  tog.textContent = term.classList.contains('active') ? "ТЕРМИНАЛ ▼" : "ТЕРМИНАЛ ▶";
};

document.getElementById('back').onclick = () => location.reload();
document.getElementById('user')?.addEventListener('keypress',e=>{if(e.key==='Enter')enter()});
</script>
</body>
</html>
